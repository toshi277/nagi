<div class="container mt-4">
  <div class="row">

    <!-- 左：User info + New post -->
    <div class="col-md-3">

      <h2>User info</h2>
      <%= image_tag "no_image.jpg", size: "120x120", class: "rounded-circle" %>

      <table class="table">
        <tbody>
          <tr>
            <th>name</th>
            <td><%= current_user.name.presence || current_user.email %></td>
          </tr>
          <tr>
            <th>introduction</th>
            <td><%= current_user.introduction %></td>
          </tr>
        </tbody>
      </table>

  
      <div class="row mb-3">
        <div class="col-md-12 text-center">
          <%= link_to edit_user_path(current_user), class: "btn btn-outline-secondary btn-block" do %>
            <i class="fas fa-user-cog"></i>
          <% end %>
        </div>
      </div>

      <h2 class="mt-4">New post</h2>

      
      <% if @post&.errors&.any? %>
        <div class="alert alert-danger">
          <ul class="mb-0">
            <% @post.errors.full_messages.each do |message| %>
              <li><%= message %></li>
            <% end %>
          </ul>
        </div>
      <% end %>

      <%= form_with model: @post, url: posts_path, local: true do |f| %>
        <div class="form-group">
          <%= f.label :title, "Title" %>
          <%= f.text_field :title, class: "form-control" %>
        </div>

        <div class="form-group">
          <%= f.label :body, "Comment" %>
          <%= f.text_area :body, class: "form-control", rows: 3 %>
        </div>
        
        <div class="form-group">
        <%= label_tag :tag_names, "Tags" %>
        <%= text_field_tag "post[tag_names]", params.dig(:post, :tag_names), class: "form-control", placeholder: "例: ととのい,静か,外気浴" %>
        </div>

        <!-- ★ Rate（投稿時のみ入力） -->
        <div class="form-group">
          <%= f.label :rate, "Rate" %>
          <div id="post_raty"></div>
        
        </div>

        <%= f.submit "Create Post", class: "btn btn-success btn-block" %>
      <% end %>

     
      <script>
      (() => {
        const elem = document.querySelector("#post_raty");
        if (!elem || elem.dataset.ratyInitialized) return;

        raty(elem, {
          starOn: "<%= asset_path('star-on.png') %>",
          starOff: "<%= asset_path('star-off.png') %>",
          starHalf: "<%= asset_path('star-half.png') %>",
          scoreName: "post[rate]"
        });

        elem.dataset.ratyInitialized = "true";
      })();
      </script>

    </div>

    <!-- 右：Posts -->
    <div class="col-md-9">
      <h2 class="mb-3">Posts</h2>

      <table class="table table-hover">
        <thead>
          <tr>
            <th>User</th>
            <th>Title</th>
            <th>Likes</th>
            <th>Comments</th>
            <th>Rate</th>
            <th></th>
          </tr>
        </thead>

        <tbody>
          <% @posts.each do |post| %>
            <tr>

             
              <td>
                <% if post.user.present? %>
                  <%= post.user.name.presence || post.user.email %>
                <% else %>
                  <span class="text-muted">退会ユーザー</span>
                <% end %>
              </td>

              <td><%= link_to post.title, post_path(post) %></td>

              <!-- ❤️ Likes -->
              <td>
                <% if user_signed_in? %>
                  <% if post.favorited_by?(current_user) %>
                    <%= link_to post_favorite_path(post),
                                method: :delete,
                                class: "text-danger text-decoration-none" do %>
                      <i class="fas fa-heart"></i>
                      <span class="ml-1"><%= post.favorites.count %></span>
                    <% end %>
                  <% else %>
                    <%= link_to post_favorite_path(post),
                                method: :post,
                                class: "text-secondary text-decoration-none" do %>
                      <i class="far fa-heart"></i>
                      <span class="ml-1"><%= post.favorites.count %></span>
                    <% end %>
                  <% end %>
                <% else %>
                  <i class="far fa-heart"></i>
                  <span class="ml-1"><%= post.favorites.count %></span>
                <% end %>
              </td>

              <td><%= post.post_comments.count %></td>

              
              <td>
                <div class="post-rate" data-score="<%= post.rate || 0 %>"></div>
              </td>

              <td>
                <%= link_to "コメント欄へ", post_path(post), class: "btn btn-sm btn-outline-secondary" %>
              </td>

            </tr>
          <% end %>
        </tbody>
      </table>

      <script>
      (() => {
        document.querySelectorAll(".post-rate").forEach((elem) => {
          if (elem.dataset.ratyInitialized) return;

          raty(elem, {
            starOn: "<%= asset_path('star-on.png') %>",
            starOff: "<%= asset_path('star-off.png') %>",
            starHalf: "<%= asset_path('star-half.png') %>",
            readOnly: true,
            score: elem.dataset.score
          });

          elem.dataset.ratyInitialized = "true";
        });
      })();
      </script>

    </div>

  </div>
</div>